# Vector configuration demonstrating VRL modifications with automatic OTLP conversion
#
# This config shows that users can modify native log events with VRL transforms
# and the OTLP encoder will still automatically convert them to OTLP format.
#
# This is the recommended approach for enriching/modifying logs before sending
# to an OTLP-compatible backend.

sources:
  source0:
    type: opentelemetry
    grpc:
      address: 0.0.0.0:4317
    http:
      address: 0.0.0.0:4318
      keepalive:
        max_connection_age_jitter_factor: 0.1
        max_connection_age_secs: 300
    # use_otlp_decoding: false (default) - logs are in flat native format

  internal_metrics:
    type: internal_metrics
    scrape_interval_secs: 60

transforms:
  # Enrich logs with additional attributes and resources
  enrich_logs:
    type: remap
    inputs:
      - source0.logs
    source: |
      # Add custom attributes
      .attributes.processed_by = "vector"
      .attributes.pipeline = "e2e-test"

      # Add resource attributes
      .resources."deployment.environment" = "e2e"
      .resources."host.name" = "vector-e2e"

      # Modify severity if needed
      if .severity_text == "Info" {
        .severity_number = 9
      }

sinks:
  # OpenTelemetry sink - native logs with modifications are auto-converted
  otel_sink:
    inputs: [ "enrich_logs" ]
    type: opentelemetry
    protocol:
      type: http
      uri: http://otel-collector-sink:5318/v1/logs
      method: post
      encoding:
        # The OTLP codec automatically converts the enriched native logs
        codec: otlp
      batch:
        max_events: 1

  # File sink for verification
  otel_file_sink:
    type: file
    path: "/output/opentelemetry-native/vector-file-sink.log"
    inputs:
      - enrich_logs
    encoding:
      codec: json

  metrics_file_sink:
    type: file
    path: "/output/opentelemetry-native/vector-internal-metrics-sink.log"
    inputs:
      - internal_metrics
    encoding:
      codec: json
