transforms:
  my_transform_id:
    type: reduce
    inputs:
      - my-source-or-transform-id

tests:
  - name: single_group
    inputs: [
      {
        insert_at: my_transform_id,
        type: log,
        log_fields: { timestamp: "2020-10-07T12:33:21.223543Z",
                      message: "Received GET /path",
                      request_id: "abcd1234",
                      request_path: "/path",
                      request_params: { "key": "val" } },
      },
      {
        insert_at: my_transform_id,
        type: log,
        log_fields: { timestamp: "2020-10-07T12:33:21.832345Z", message: "Executed query in 5.2ms", request_id: "abcd1234", query: "SELECT * FROM table", query_duration_ms: 5.2 },
      },
      {
        insert_at: my_transform_id,
        type: log,
        log_fields: { timestamp: "2020-10-07T12:33:22.457423Z", message: "Rendered partial _partial.erb in 2.3ms", request_id: "abcd1234", template: "_partial.erb", render_duration_ms: 2.3 }
      },
      {
        insert_at: my_transform_id,
        type: log,
        log_fields: { timestamp: "2020-10-07T12:33:22.543323Z", message: "Executed query in 7.8ms", request_id: "abcd1234", query: "SELECT * FROM table", query_duration_ms: 7.8 }
      },
      {
        insert_at: my_transform_id,
        type: log,
        log_fields: { timestamp: "2020-10-07T12:33:22.742322Z", message: "Sent 200 in 15.2ms", request_id: "abcd1234", response_status: 200, response_duration_ms: 5.2 }
      }
    ]

    outputs:
      - extract_from: my_transform_id
        conditions:
          - type: vrl
            source: |
              assert_eq!(."message", "Received GET /path");
              assert_eq!(."query", "SELECT * FROM table");
              assert_eq!(."query_duration_ms", 13.0);
              assert_eq!(."render_duration_ms", 2.3);
              assert_eq!(."request_id", "abcd1234");
              assert_eq!(."request_params", {"key": "val"});
              assert_eq!(."request_path", "/path");
              assert_eq!(."response_duration_ms", 5.2);
              assert_eq!(."response_status", 200);
              assert_eq!(."template", "_partial.erb");
              assert_eq!(."timestamp", "2020-10-07T12:33:21.223543Z");
