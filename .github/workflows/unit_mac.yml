name: Unit - Mac

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string


permissions:
  contents: read

jobs:
  unit-mac:
    runs-on: macos-14-xlarge
    timeout-minutes: 90
    env:
      CARGO_INCREMENTAL: 0
    steps:
      - name: Checkout branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ inputs.ref }}

      - uses: ./.github/actions/setup
        with:
          rust: true
          cargo-nextest: true
          protoc: true

      # Some tests e.g. `reader_exits_cleanly_when_writer_done_and_in_flight_acks` are flaky.
      - name: Run tests
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          timeout_minutes: 45
          max_attempts: 3
          command: make test

      - run: make test-behavior
